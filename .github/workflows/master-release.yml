name: Master Release

on:
  workflow_dispatch:
    inputs:
      staging_validation:
        description: 'Confirm staging has been tested and is ready for release'
        required: true
        type: boolean
        default: false

env:
  GH_USERNAME: github-actions[bot]

jobs:
  validate-staging:
    runs-on: ubuntu-latest
    outputs:
      release-version: ${{ steps.get-version.outputs.version }}
      release-tag: ${{ steps.get-version.outputs.tag }}
    steps:
      - name: Validate input
        if: ${{ !github.event.inputs.staging_validation }}
        run: |
          echo "âŒ Staging validation checkbox must be checked to proceed"
          exit 1

      - name: Checkout staging branch
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0

      - name: Check staging branch exists and has commits ahead of master
        run: |
          # Ensure we're on staging
          if [ "$(git branch --show-current)" != "staging" ]; then
            echo "âŒ Not on staging branch"
            exit 1
          fi

          # Check if staging is ahead of master
          git fetch origin master
          AHEAD=$(git rev-list --count origin/master..staging)
          if [ "$AHEAD" -eq "0" ]; then
            echo "âŒ Staging branch has no commits ahead of master"
            exit 1
          fi

          echo "âœ… Staging is $AHEAD commits ahead of master"

      - name: Check for release tag on staging
        id: get-version
        run: |
          # Check if HEAD has a version tag
          if git describe --tags --exact-match HEAD 2>/dev/null; then
            TAG=$(git describe --tags --exact-match HEAD)
            VERSION=$(echo "$TAG" | sed 's/^v//')
            echo "âœ… Found release tag: $TAG"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            echo "âŒ No release tag found on staging HEAD"
            exit 1
          fi

      - name: Check for changelog entry
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if grep -q "## \[$VERSION\]" CHANGELOG.md || grep -q "## $VERSION" CHANGELOG.md; then
            echo "âœ… Changelog entry found for version $VERSION"
          else
            echo "âŒ No changelog entry found for version $VERSION"
            exit 1
          fi

      - name: Check for binaries
        run: |
          if [ -d "pyfunnel/lib" ] && [ "$(ls -A pyfunnel/lib)" ]; then
            echo "âœ… Binaries found in pyfunnel/lib"
            ls -la pyfunnel/lib/
          else
            echo "âŒ No binaries found in pyfunnel/lib"
            exit 1
          fi

      - name: Check staging validation marker
        run: |
          if [ -f ".staging-validated" ]; then
            echo "âœ… Staging validation marker found:"
            cat .staging-validated
            
            # Verify the marker contains the expected version
            if grep -q "Version: ${{ steps.get-version.outputs.version }}" .staging-validated; then
              echo "âœ… Validation marker matches expected version"
            else
              echo "âŒ Validation marker version mismatch"
              exit 1
            fi
          else
            echo "âŒ No staging validation marker found"
            echo "Please run the staging-release workflow first"
            exit 1
          fi

  merge-to-master:
    needs: validate-staging
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge staging to master
        run: |
          git config --global user.name "${GH_USERNAME}"
          git config --global user.email "${GH_USERNAME}@users.noreply.github.com"

          # Fetch staging
          git fetch origin staging

          # Merge staging into master
          git merge origin/staging --no-edit

          # Remove the staging validation marker before finalizing
          if [ -f ".staging-validated" ]; then
            git rm .staging-validated
            git commit -m "chore: remove staging validation marker"
          fi

          # Push to master
          git push origin master
          git push origin --tags

  create-github-release:
    needs: [validate-staging, merge-to-master]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ needs.validate-staging.outputs.release-version }}"

          # Extract changelog section for this version
          sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > release-notes.md

          # If no bracketed version found, try without brackets
          if [ ! -s release-notes.md ]; then
            sed -n "/## $VERSION/,/## /p" CHANGELOG.md | sed '$d' > release-notes.md
          fi

          echo "Release notes:"
          cat release-notes.md

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate-staging.outputs.release-tag }}
          release_name: Release ${{ needs.validate-staging.outputs.release-tag }}
          body_path: release-notes.md
          draft: false
          prerelease: false

  publish-to-pypi:
    needs: [validate-staging, merge-to-master, create-github-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine

      - name: Build package
        run: python -m build --sdist --wheel .

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          python -m twine upload dist/*

  notify-completion:
    needs: [validate-staging, merge-to-master, create-github-release, publish-to-pypi]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Master Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.validate-staging.outputs.release-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Staging Validation**: ${{ needs.validate-staging.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge to Master**: ${{ needs.merge-to-master.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: ${{ needs.create-github-release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PyPI Publish**: ${{ needs.publish-to-pypi.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.publish-to-pypi.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Release ${{ needs.validate-staging.outputs.release-tag }} completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ Available on PyPI: https://pypi.org/project/pyfunnel/${{ needs.validate-staging.outputs.release-version }}/" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ·ï¸ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-staging.outputs.release-tag }}" >> $GITHUB_STEP_SUMMARY
          fi
